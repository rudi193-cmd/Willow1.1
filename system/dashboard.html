<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Willow Control Desktop</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
        }
        h1 { margin-bottom: 20px; font-size: 24px; }

        .cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            max-width: 1600px;
        }

        .card {
            background: #111;
            border: 1px solid #00ff00;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .card:hover {
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            transform: translateY(-2px);
        }
        .card h2 { font-size: 18px; margin-bottom: 10px; }
        .card p { color: #00cc00; font-size: 14px; }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
        .modal-overlay.show { display: flex; align-items: center; justify-content: center; }

        .modal {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            width: 1200px;
        }
        .modal h2 { margin-bottom: 20px; border-bottom: 1px solid #00ff00; padding-bottom: 10px; }
        .modal button {
            background: #003300;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        .modal button:hover { background: #00ff00; color: #000; }

        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        th { color: #00ff00; }
        td { color: #00cc00; }
    </style>
</head>
<body>
    <h1>üß† WILLOW CONTROL DESKTOP</h1>

    <div class="cards">
        <div class="card" onclick="openModal('providers')">
            <h2>üåê Providers</h2>
            <p id="providers-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('queues')">
            <h2>üì• Queues</h2>
            <p id="queues-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('nodes')">
            <h2>üå≥ Nodes</h2>
            <p id="nodes-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('learning')">
            <h2>üß† Learning</h2>
            <p id="learning-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('rules')">
            <h2>üí° Rules</h2>
            <p id="rules-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('patterns')">
            <h2>üìä Patterns</h2>
            <p id="patterns-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('governance')">
            <h2>‚öñÔ∏è Governance</h2>
            <p id="governance-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('safe')">
            <h2>üîí SAFE Sync</h2>
            <p id="safe-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('files')">
            <h2>üìÅ Files</h2>
            <p id="files-summary">Loading...</p>
        </div>
        <div class="card" onclick="openModal('routing-approval')"><h2>üìã Routing Approval</h2><p id="routing-summary">Loading...</p></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-overlay" onclick="closeModalIfOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 id="modal-title"></h2>
            <div id="modal-body"></div>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        async function loadSummaries() {
            // Providers
            try {
                const r = await fetch('/api/health/providers');
                const d = await r.json();
                const p = Object.values(d.providers || {});
                const h = p.filter(x => x.status === 'healthy').length;
                const dg = p.filter(x => x.status === 'degraded').length;
                const b = p.filter(x => x.status === 'blacklisted').length;
                document.getElementById('providers-summary').textContent = `${h} healthy, ${dg} degraded, ${b} blacklisted`;
            } catch(e) { document.getElementById('providers-summary').textContent = 'Error'; }

            // Queues
            try {
                const r = await fetch('/api/health/queues');
                const d = await r.json();
                const q = Object.values(d.queues || {});
                const total = q.reduce((sum, x) => sum + x.count, 0);
                document.getElementById('queues-summary').textContent = `${total} files in ${q.length} queues`;
            } catch(e) { document.getElementById('queues-summary').textContent = 'Error'; }

            // Nodes
            try {
                const r = await fetch('/api/health/nodes');
                const d = await r.json();
                const n = Object.values(d.nodes || {});
                const h = n.filter(x => x.status === 'healthy').length;
                const nodb = n.filter(x => x.status === 'no_db').length;
                document.getElementById('nodes-summary').textContent = `${h} healthy, ${nodb} no_db`;
            } catch(e) { document.getElementById('nodes-summary').textContent = 'Error'; }

            // Learning (Fleet Feedback)
            try {
                const r = await fetch('/api/feedback/stats');
                const d = await r.json();
                const providers = Object.keys(d.by_provider || {}).length;
                const tasks = Object.keys(d.by_task || {}).length;
                document.getElementById('learning-summary').textContent = `${providers} providers, ${tasks} task types tracked`;
            } catch(e) { document.getElementById('learning-summary').textContent = 'Error'; }

            // Rules
            try {
                const r = await fetch('/api/patterns/suggestions');
                const d = await r.json();
                document.getElementById('rules-summary').textContent = `${(d.suggestions || []).length} rules suggested`;
            } catch(e) { document.getElementById('rules-summary').textContent = 'Error'; }

            // Patterns
            try {
                const r = await fetch('/api/patterns/stats');
                const d = await r.json();
                document.getElementById('patterns-summary').textContent = `${d.total_routings || 0} total routings`;
            } catch(e) { document.getElementById('patterns-summary').textContent = 'Error'; }

            // Governance
            try {
                const [sysR, auditR] = await Promise.all([
                    fetch('/api/system/status'),
                    fetch('/api/governance/audit/head')
                ]);
                const d = await sysR.json();
                const audit = await auditR.json();
                const pending = d.governance?.pending_commits || 0;
                const entries = audit.entry_count ?? '?';
                const status = pending > 0 ? `${pending} pending ¬∑ ${entries} audit entries` : `All clear ¬∑ ${entries} audit entries`;
                document.getElementById('governance-summary').textContent = status;
            } catch(e) { document.getElementById('governance-summary').textContent = 'Error'; }

            // SAFE
            try {
                const r = await fetch('/api/safe/status');
                const d = await r.json();
                const ok = d.reachable ? '‚úì reachable' : '‚úó unreachable';
                const sync = d.last_sync ? d.last_sync.split(' ').slice(-2).join(' ') : 'never';
                document.getElementById('safe-summary').textContent = `${ok} ¬∑ last: ${sync}`;
            } catch(e) { document.getElementById('safe-summary').textContent = 'Error'; }

            // Files
            try {
                const r = await fetch('/api/files/folders');
                const d = await r.json();
                const folders = d.folders || [];
                const total = folders.reduce((s, f) => s + f.count, 0);
                const proposed = Object.keys(d.proposed || {}).length;
                document.getElementById('files-summary').textContent =
                    `${total} files, ${folders.length} folders${proposed ? `, ${proposed} proposed` : ''}`;
            } catch(e) { document.getElementById('files-summary').textContent = 'Error'; }

            // Routing Approval
            try {
                const r = await fetch('/api/routing/proposed');
                const d = await r.json();
                document.getElementById('routing-summary').textContent = d.total + ' proposed folders pending review';
            } catch(e) { document.getElementById('routing-summary').textContent = 'Error'; }
        }

        async function openModal(type) {
            document.getElementById('modal-title').textContent = getModalTitle(type);
            document.getElementById('modal-body').innerHTML = 'Loading...';
            document.getElementById('modal-overlay').classList.add('show');

            try {
                if (type === 'providers') await loadProvidersModal();
                else if (type === 'queues') await loadQueuesModal();
                else if (type === 'rules') await loadRulesModal();
                else if (type === 'patterns') await loadPatternsModal();
                else if (type === 'nodes') await loadNodesModal();
                else if (type === 'governance') await loadGovernanceModal();
                else if (type === 'safe') await loadSafeModal();
                else if (type === 'learning') await loadLearningModal();
                else if (type === 'routing-approval') await loadRoutingApprovalModal();
                else if (type === 'files') await loadFilesModal();
                else document.getElementById('modal-body').innerHTML = `<p>${type} modal coming soon...</p>`;
            } catch(e) {
                document.getElementById('modal-body').innerHTML = `<p>Error: ${e.message}</p>`;
            }
        }

        async function loadProvidersModal() {
            const r = await fetch('/api/health/providers');
            const d = await r.json();
            const providers = d.providers || {};

            let html = '<table><tr><th>Provider</th><th>Status</th><th>Success Rate</th><th>Requests</th><th>Failures</th><th>Last Success</th><th>Blacklisted Until</th><th>Actions</th></tr>';
            for (const [name, p] of Object.entries(providers)) {
                const statusColor = p.status === 'healthy' ? '#00ff00' : p.status === 'degraded' ? '#ffaa00' : '#ff0000';
                const rateColor = p.success_rate >= 80 ? '#00ff00' : p.success_rate >= 50 ? '#ffaa00' : '#ff0000';

                const lastSuccess = p.last_success ? new Date(p.last_success).toLocaleString() : 'Never';
                const blacklistedUntil = p.blacklisted_until ? new Date(p.blacklisted_until).toLocaleString() : '-';

                let actions = '';
                if (p.status === 'blacklisted') {
                    actions += `<button onclick="unblacklistProvider('${name}')" style="background: #330000; border: 1px solid #ff0000; color: #ff0000; padding: 5px 10px; cursor: pointer; margin-right: 5px;">Unblacklist</button>`;
                }
                actions += `<button onclick="resetProviderHealth('${name}')" style="background: #003300; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer;">Reset</button>`;

                html += `<tr>`;
                html += `<td>${name}</td>`;
                html += `<td style="color:${statusColor}">${p.status}</td>`;
                html += `<td style="color:${rateColor}">${p.success_rate.toFixed(1)}%</td>`;
                html += `<td>${p.total_requests}</td>`;
                html += `<td>${p.consecutive_failures}</td>`;
                html += `<td style="font-size: 11px;">${lastSuccess}</td>`;
                html += `<td style="font-size: 11px;">${blacklistedUntil}</td>`;
                html += `<td>${actions}</td>`;
                html += `</tr>`;
            }
            html += '</table>';

            html += '<div style="margin-top: 20px; padding: 15px; background: #111; border: 1px solid #00ff00;">';
            html += '<h3 style="margin-bottom: 10px;">Provider Status Legend</h3>';
            html += '<p style="color: #00cc00; margin-bottom: 5px;"><span style="color: #00ff00;">‚óè Healthy:</span> Provider is operational and accepting requests</p>';
            html += '<p style="color: #00cc00; margin-bottom: 5px;"><span style="color: #ffaa00;">‚óè Degraded:</span> Provider has 1-4 consecutive failures</p>';
            html += '<p style="color: #00cc00;"><span style="color: #ff0000;">‚óè Blacklisted:</span> Provider has 5+ consecutive failures, excluded from rotation</p>';
            html += '</div>';

            document.getElementById('modal-body').innerHTML = html;
        }

        async function loadQueuesModal() {
            const r = await fetch('/api/health/queues');
            const d = await r.json();
            const queues = d.queues || {};

            let html = '<div id="queues-main-view">';
            html += '<table><tr><th>Queue</th><th>Status</th><th>Files Pending</th><th>Message</th><th>Actions</th></tr>';
            for (const [name, q] of Object.entries(queues)) {
                const statusColor = q.status === 'healthy' ? '#00ff00' : q.status === 'elevated' ? '#ffaa00' : '#ff0000';

                let actions = '';
                actions += `<button onclick="viewQueueFiles('${name}')" style="background: #003300; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer; margin-right: 5px;">View Files</button>`;
                if (q.count > 0) {
                    actions += `<button onclick="clearQueue('${name}', ${q.count})" style="background: #330000; border: 1px solid #ff0000; color: #ff0000; padding: 5px 10px; cursor: pointer;">Clear Queue</button>`;
                }

                html += `<tr>`;
                html += `<td>${name}</td>`;
                html += `<td style="color:${statusColor}">${q.status}</td>`;
                html += `<td>${q.count}</td>`;
                html += `<td>${q.message}</td>`;
                html += `<td>${actions}</td>`;
                html += `</tr>`;
            }
            html += '</table>';

            html += '<div style="margin-top: 20px; padding: 15px; background: #111; border: 1px solid #00ff00;">';
            html += '<h3 style="margin-bottom: 10px;">Queue Status Legend</h3>';
            html += '<p style="color: #00cc00; margin-bottom: 5px;"><span style="color: #00ff00;">‚óè Healthy:</span> Normal operation, fewer than 25 files pending</p>';
            html += '<p style="color: #00cc00; margin-bottom: 5px;"><span style="color: #ffaa00;">‚óè Elevated:</span> 25-50 files pending, monitor closely</p>';
            html += '<p style="color: #00cc00;"><span style="color: #ff0000;">‚óè Backlog:</span> More than 50 files pending, requires attention</p>';
            html += '</div>';
            html += '</div>';

            // Hidden file list view (shown when View Files is clicked)
            html += '<div id="queue-files-view" style="display: none;"></div>';

            document.getElementById('modal-body').innerHTML = html;
        }

        async function viewQueueFiles(queueName) {
            const r = await fetch(`/api/queues/files?queue=${queueName}`);
            const d = await r.json();

            if (d.error) {
                alert(`Error: ${d.error}`);
                return;
            }

            const files = d.files || [];

            let html = '<div style="margin-bottom: 15px;">';
            html += `<button onclick="loadQueuesModal()" style="background: #003300; border: 1px solid #00ff00; color: #00ff00; padding: 8px 16px; cursor: pointer;">‚Üê Back to Queues</button>`;
            html += '</div>';

            html += `<h3 style="margin-bottom: 15px;">Files in Queue: ${queueName} (${files.length} files)</h3>`;

            if (files.length === 0) {
                html += '<p style="color: #00cc00;">No files in this queue.</p>';
            } else {
                html += '<table><tr><th>File Name</th><th>Size (bytes)</th><th>Last Modified</th></tr>';
                for (const file of files) {
                    const modDate = new Date(file.modified * 1000).toLocaleString();
                    html += `<tr>`;
                    html += `<td>${file.name}</td>`;
                    html += `<td>${file.size}</td>`;
                    html += `<td style="font-size: 11px;">${modDate}</td>`;
                    html += `</tr>`;
                }
                html += '</table>';

                html += `<div style="margin-top: 20px;">`;
                html += `<button onclick="clearQueue('${queueName}', ${files.length})" style="background: #330000; border: 1px solid #ff0000; color: #ff0000; padding: 10px 20px; cursor: pointer;">Clear All ${files.length} Files</button>`;
                html += `</div>`;
            }

            // Hide main view, show file view
            document.getElementById('queues-main-view').style.display = 'none';
            document.getElementById('queue-files-view').style.display = 'block';
            document.getElementById('queue-files-view').innerHTML = html;
        }

        async function clearQueue(queueName, fileCount) {
            if (!confirm(`Clear all ${fileCount} files from queue: ${queueName}?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const r = await fetch('/api/queues/clear', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({queue: queueName})
                });
                const data = await r.json();

                if (data.success) {
                    alert(`‚úì Cleared ${data.files_deleted} files from ${queueName} queue!`);
                    loadQueuesModal();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch(e) {
                alert(`Failed to clear queue: ${e.message}`);
            }
        }

        async function loadRulesModal() {
            const r = await fetch('/api/patterns/suggestions');
            const d = await r.json();
            const suggestions = d.suggestions || [];

            let html = '';

            if (suggestions.length === 0) {
                html += '<div style="padding: 20px; text-align: center;">';
                html += '<p style="color: #00cc00; font-size: 16px; margin-bottom: 10px;">No routing rules suggested yet.</p>';
                html += '<p style="color: #00cc00;">Willow will automatically suggest rules as it learns your routing patterns.</p>';
                html += '</div>';
            } else {
                html += '<p style="color: #00cc00; margin-bottom: 15px;">Willow has learned these routing patterns. Review and confirm or reject each suggestion:</p>';
                html += '<table><tr><th>Rule</th><th>Confidence</th><th>Based On</th><th>Actions</th></tr>';
                for (const s of suggestions) {
                    const confColor = s.confidence >= 0.8 ? '#00ff00' : s.confidence >= 0.6 ? '#ffaa00' : '#ff8800';
                    const confPercent = (s.confidence * 100).toFixed(0);

                    const ruleData = btoa(JSON.stringify({type: s.pattern_type, value: s.pattern_value, dest: s.destination}));
                    html += `<tr>`;
                    html += `<td>${s.rule}</td>`;
                    html += `<td style="color:${confColor}">${confPercent}%</td>`;
                    html += `<td>${s.based_on}</td>`;
                    html += `<td>`;
                    html += `<button class="confirm-rule-btn" data-rule="${ruleData}" style="background: #003300; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer; margin-right: 5px;">Confirm</button>`;
                    html += `<button class="reject-rule-btn" data-rule="${ruleData}" style="background: #330000; border: 1px solid #ff0000; color: #ff0000; padding: 5px 10px; cursor: pointer;">Reject</button>`;
                    html += `</td>`;
                    html += `</tr>`;
                }
                html += '</table>';
            }

            html += '<div style="margin-top: 20px; padding: 15px; background: #111; border: 1px solid #00ff00;">';
            html += '<h3 style="margin-bottom: 10px;">About Routing Rules</h3>';
            html += '<p style="color: #00cc00; margin-bottom: 5px;"><strong>Confirm:</strong> Make this an automatic rule. Files matching this pattern will be routed automatically.</p>';
            html += '<p style="color: #00cc00; margin-bottom: 5px;"><strong>Reject:</strong> Remove this suggestion. Willow will not suggest this pattern again.</p>';
            html += '<p style="color: #00cc00;"><strong>Confidence:</strong> Based on how consistently you have routed files this way in the past.</p>';
            html += '</div>';

            document.getElementById('modal-body').innerHTML = html;

            // Attach event listeners to rule buttons
            document.querySelectorAll('.confirm-rule-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const data = JSON.parse(atob(btn.dataset.rule));
                    confirmRule(data.type, data.value, data.dest);
                });
            });
            document.querySelectorAll('.reject-rule-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const data = JSON.parse(atob(btn.dataset.rule));
                    rejectRule(data.type, data.value, data.dest);
                });
            });
        }

        async function confirmRule(patternType, patternValue, destination) {
            if (!confirm(`Confirm routing rule?\n\nAll future files matching:\n  ${patternValue}\n\nWill be automatically routed to:\n  ${destination}\n\nYou can still override this manually when needed.`)) {
                return;
            }

            try {
                const r = await fetch('/api/patterns/confirm_rule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        pattern_type: patternType,
                        pattern_value: patternValue,
                        destination: destination
                    })
                });
                const data = await r.json();

                if (data.success) {
                    alert(`‚úì Routing rule confirmed!\n\nFiles matching "${patternValue}" will now be automatically routed to "${destination}".`);
                    loadRulesModal();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch(e) {
                alert(`Failed to confirm rule: ${e.message}`);
            }
        }

        async function rejectRule(patternType, patternValue, destination) {
            if (!confirm(`Reject routing rule?\n\nThis will remove the suggestion:\n  ${patternValue} ‚Üí ${destination}\n\nWillow will not suggest this pattern again.`)) {
                return;
            }

            try {
                const r = await fetch('/api/patterns/reject_rule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        pattern_type: patternType,
                        pattern_value: patternValue,
                        destination: destination
                    })
                });
                const data = await r.json();

                if (data.success) {
                    alert(`‚úì Rule rejected and removed from suggestions.`);
                    loadRulesModal();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch(e) {
                alert(`Failed to reject rule: ${e.message}`);
            }
        }

        async function loadPatternsModal() {
            const r = await fetch('/api/patterns/stats');
            const d = await r.json();

            if (d.error) {
                document.getElementById('modal-body').innerHTML = `<p style="color: #ff0000;">Error: ${d.error}</p>`;
                return;
            }

            const total = d.total_routings || 0;
            const byDest = d.by_destination || {};
            const byType = d.by_file_type || {};
            const anomalies = d.unresolved_anomalies || 0;
            const days = d.period_days || 30;

            let html = '';

            // Summary stats
            html += '<div style="margin-bottom: 20px; padding: 15px; background: #111; border: 1px solid #00ff00;">';
            html += '<h3 style="margin-bottom: 10px;">Routing Statistics (Last ' + days + ' Days)</h3>';
            html += '<p style="color: #00cc00; font-size: 14px; margin-bottom: 5px;">Total Routings: <span style="color: #00ff00; font-size: 16px;">' + total + '</span></p>';
            if (anomalies > 0) {
                html += '<p style="color: #ff8800;">Unresolved Anomalies: <span style="color: #ff0000; font-size: 16px;">' + anomalies + '</span></p>';
            } else {
                html += '<p style="color: #00cc00;">Unresolved Anomalies: <span style="color: #00ff00;">0</span></p>';
            }
            html += '</div>';

            // By Destination
            html += '<h3 style="margin: 20px 0 10px;">Top Destinations</h3>';
            const destEntries = Object.entries(byDest).sort((a, b) => b[1] - a[1]);
            if (destEntries.length > 0) {
                const maxCount = destEntries[0][1];
                html += '<table style="width: 100%;"><tr><th>Destination</th><th>Count</th><th>Distribution</th></tr>';
                for (const [dest, count] of destEntries.slice(0, 10)) {
                    const pct = total > 0 ? (count / total * 100).toFixed(1) : 0;
                    const barWidth = maxCount > 0 ? (count / maxCount * 100) : 0;
                    html += `<tr>`;
                    html += `<td>${dest}</td>`;
                    html += `<td>${count}</td>`;
                    html += `<td><div style="background: #003300; width: 100%; height: 20px; border: 1px solid #00ff00;"><div style="background: #00ff00; width: ${barWidth}%; height: 100%;"></div></div> ${pct}%</td>`;
                    html += `</tr>`;
                }
                html += '</table>';
            } else {
                html += '<p style="color: #00cc00;">No routing data available for this period.</p>';
            }

            // By File Type
            html += '<h3 style="margin: 20px 0 10px;">Top File Types</h3>';
            const typeEntries = Object.entries(byType).sort((a, b) => b[1] - a[1]);
            if (typeEntries.length > 0) {
                const maxTypeCount = typeEntries[0][1];
                html += '<table style="width: 100%;"><tr><th>File Type</th><th>Count</th><th>Distribution</th></tr>';
                for (const [type, count] of typeEntries.slice(0, 10)) {
                    const pct = total > 0 ? (count / total * 100).toFixed(1) : 0;
                    const barWidth = maxTypeCount > 0 ? (count / maxTypeCount * 100) : 0;
                    const displayType = type || 'unknown';
                    html += `<tr>`;
                    html += `<td>${displayType}</td>`;
                    html += `<td>${count}</td>`;
                    html += `<td><div style="background: #003300; width: 100%; height: 20px; border: 1px solid #00ff00;"><div style="background: #00ff00; width: ${barWidth}%; height: 100%;"></div></div> ${pct}%</td>`;
                    html += `</tr>`;
                }
                html += '</table>';
            } else {
                html += '<p style="color: #00cc00;">No file type data available for this period.</p>';
            }

            // Info box
            html += '<div style="margin-top: 20px; padding: 15px; background: #111; border: 1px solid #00ff00;">';
            html += '<h3 style="margin-bottom: 10px;">About Pattern Recognition</h3>';
            html += '<p style="color: #00cc00; margin-bottom: 5px;">Willow automatically tracks your routing decisions and learns patterns over time.</p>';
            html += '<p style="color: #00cc00; margin-bottom: 5px;">These statistics show where files are being routed and help identify trends.</p>';
            html += '<p style="color: #00cc00;">Use the Rules modal to confirm suggested routing patterns.</p>';
            html += '</div>';

            document.getElementById('modal-body').innerHTML = html;
        }

        async function loadNodesModal() {
            const r = await fetch('/api/health/nodes');
            const d = await r.json();
            const nodes = d.nodes || {};

            let html = '<table><tr><th>Node</th><th>Status</th><th>Message</th><th>Actions</th></tr>';
            for (const [name, node] of Object.entries(nodes)) {
                const color = node.status === 'healthy' ? '#00ff00' : node.status === 'no_db' ? '#ff0000' : '#ffaa00';
                let actions = '';
                if (node.status === 'no_db') {
                    actions = `<button onclick="createNodeDB('${name}')" style="background: #003300; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer;">Create DB</button>`;
                }
                html += `<tr><td>${name}</td><td style="color:${color}">${node.status}</td><td>${node.message}</td><td>${actions}</td></tr>`;
            }
            html += '</table>';
            document.getElementById('modal-body').innerHTML = html;
        }

        async function createNodeDB(nodeName) {
            if (!confirm(`Create knowledge database for node: ${nodeName}?`)) {
                return;
            }

            try {
                const r = await fetch('/api/nodes/create_db', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({node_name: nodeName})
                });
                const data = await r.json();

                if (data.success) {
                    alert(`‚úì Database created for ${nodeName}!\n\nThe node now has a knowledge.db file and can store knowledge atoms.`);
                    // Reload modal to show updated status
                    loadNodesModal();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch(e) {
                alert(`Failed to create database: ${e.message}`);
            }
        }

        async function unblacklistProvider(providerName) {
            if (!confirm(`Unblacklist provider: ${providerName}?\n\nThis will mark it as healthy and allow it to receive requests again.`)) {
                return;
            }

            try {
                const r = await fetch('/api/health/providers/unblacklist', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider: providerName})
                });
                const data = await r.json();

                if (data.success) {
                    alert(`‚úì ${providerName} unblacklisted!\n\nProvider is now marked as healthy and will be included in the rotation.`);
                    loadProvidersModal();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch(e) {
                alert(`Failed to unblacklist provider: ${e.message}`);
            }
        }

        async function resetProviderHealth(providerName) {
            if (!confirm(`Reset health counters for: ${providerName}?\n\nThis will:\n- Reset consecutive failures to 0\n- Mark as healthy\n- Clear blacklist status`)) {
                return;
            }

            try {
                const r = await fetch('/api/health/providers/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider: providerName})
                });
                const data = await r.json();

                if (data.success) {
                    alert(`‚úì ${providerName} health reset!\n\nAll counters cleared and provider marked as healthy.`);
                    loadProvidersModal();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch(e) {
                alert(`Failed to reset provider health: ${e.message}`);
            }
        }

        async function loadGovernanceModal() {
            const [sysR, headR, verifyR] = await Promise.all([
                fetch('/api/system/status'),
                fetch('/api/governance/audit/head'),
                fetch('/api/governance/audit/verify'),
            ]);
            const d = await sysR.json();
            const gov = d.governance || {};
            const head = await headR.json();
            const verify = await verifyR.json();

            const chainOk = verify.valid === true;
            const chainColor = chainOk ? '#00ff00' : '#ff4444';
            const chainLabel = chainOk ? '‚úì Chain intact' : '‚úó Chain broken';

            let html = '<div>';
            html += `<p><strong>Pending Commits:</strong> ${gov.pending_commits || 0}</p>`;
            if (gov.last_ratification) {
                html += `<p><strong>Last Ratification:</strong> ${new Date(gov.last_ratification).toLocaleString()}</p>`;
            }
            html += `<hr style="border-color:#333;margin:12px 0">`;
            html += `<p><strong>Audit Chain:</strong> <span style="color:${chainColor}">${chainLabel}</span></p>`;
            html += `<p><strong>Entries:</strong> ${head.entry_count ?? '?'} &nbsp;|&nbsp; <strong>Sequence:</strong> ${head.sequence ?? '?'}</p>`;
            if (head.head_hash) {
                html += `<p style="font-size:11px;color:#555;word-break:break-all"><strong>Head:</strong> ${head.head_hash}</p>`;
            }
            if (!chainOk && verify.actual_head_computed) {
                html += `<p style="color:#ff4444;font-size:11px">Expected: ${verify.expected_head}<br>Computed: ${verify.actual_head_computed}</p>`;
            }
            html += '<p style="margin-top: 20px;"><a href="/governance" target="_blank" style="color: #00ff00; text-decoration: underline;">Open Full Governance Dashboard ‚Üí</a></p>';
            html += '</div>';

            document.getElementById('modal-body').innerHTML = html;
        }

        async function loadSafeModal() {
            document.getElementById('modal-body').innerHTML = '<p>Loading...</p>';
            const r = await fetch('/api/safe/status');
            const d = await r.json();

            const reachColor = d.reachable ? '#00ff00' : '#ff4444';
            const reachLabel = d.reachable ? '‚úì Reachable' : '‚úó Unreachable';

            let html = '<div>';
            html += `<p><strong>SAFE Repo:</strong> <span style="color:${reachColor}">${reachLabel}</span></p>`;
            html += `<p style="font-size:11px;color:#555">${d.repo_path || ''}</p>`;
            if (d.last_sync) html += `<p><strong>Last Sync:</strong> ${d.last_sync}</p>`;
            if (d.last_error) html += `<p style="color:#ff8800"><strong>Last Error:</strong> ${d.last_error}</p>`;

            if (d.recent_log && d.recent_log.length) {
                html += `<hr style="border-color:#333;margin:12px 0"><p><strong>Recent Log:</strong></p>`;
                html += `<pre style="font-size:10px;color:#555;white-space:pre-wrap;max-height:150px;overflow-y:auto">${d.recent_log.join('\n')}</pre>`;
            }

            html += `<hr style="border-color:#333;margin:12px 0">`;
            html += `<button onclick="triggerSafeSync()" style="background:#003300;border:1px solid #00ff00;color:#00ff00;padding:8px 16px;cursor:pointer;border-radius:4px">‚ñ∂ Sync Now</button>`;
            html += `<span id="safe-sync-status" style="margin-left:12px;font-size:12px;color:#888"></span>`;
            html += '</div>';

            document.getElementById('modal-body').innerHTML = html;
        }

        async function triggerSafeSync() {
            document.getElementById('safe-sync-status').textContent = 'Running...';
            try {
                const r = await fetch('/api/safe/sync', {method: 'POST'});
                const d = await r.json();
                if (d.success) {
                    document.getElementById('safe-sync-status').textContent = '‚úì Done';
                } else {
                    document.getElementById('safe-sync-status').textContent = `‚úó ${d.error || d.stderr || 'failed'}`;
                }
            } catch(e) {
                document.getElementById('safe-sync-status').textContent = `‚úó ${e.message}`;
            }
        }

        async function loadLearningModal() {
            // Fetch feedback stats
            const statsR = await fetch('/api/feedback/stats');
            const stats = await statsR.json();

            // Fetch unannotated routings
            const routingsR = await fetch('/api/annotations/unannotated?limit=10');
            const routingsData = await routingsR.json();
            const routings = routingsData.routings || [];

            // Fetch annotation stats
            const annotStatsR = await fetch('/api/annotations/stats');
            const annotStats = await annotStatsR.json();

            let html = '<div>';

            // Stats by provider
            html += '<h3 style="margin-bottom: 10px;">üìä Fleet Performance by Provider</h3>';
            html += '<table><tr><th>Provider</th><th>Avg Quality</th><th>Total Feedback</th><th>Poor Count</th></tr>';
            for (const [provider, data] of Object.entries(stats.by_provider || {})) {
                const qualColor = data.avg_quality >= 4 ? '#00ff00' : data.avg_quality >= 3 ? '#ffaa00' : '#ff0000';
                html += `<tr><td>${provider}</td><td style="color:${qualColor}">${data.avg_quality}/5</td><td>${data.total}</td><td>${data.poor_count}</td></tr>`;
            }
            html += '</table>';

            // Stats by task type
            html += '<h3 style="margin: 20px 0 10px;">üìù Fleet Performance by Task Type</h3>';
            html += '<table><tr><th>Task Type</th><th>Avg Quality</th><th>Total Feedback</th></tr>';
            for (const [task, data] of Object.entries(stats.by_task || {})) {
                const qualColor = data.avg_quality >= 4 ? '#00ff00' : data.avg_quality >= 3 ? '#ffaa00' : '#ff0000';
                html += `<tr><td>${task}</td><td style="color:${qualColor}">${data.avg_quality}/5</td><td>${data.total}</td></tr>`;
            }
            html += '</table>';

            // File Routing Annotations Section
            html += '<h3 style="margin: 30px 0 10px;">üìÅ File Routing Decisions (Verify & Annotate)</h3>';
            if (annotStats.overall) {
                const acc = annotStats.overall.accuracy_rate || 0;
                const accColor = acc >= 90 ? '#00ff00' : acc >= 75 ? '#ffaa00' : '#ff0000';
                html += `<p style="color: #00cc00;">Routing Accuracy: <span style="color:${accColor}">${acc.toFixed(1)}%</span> `;
                html += `(${annotStats.overall.correct_count} correct, ${annotStats.overall.incorrect_count} wrong, ${annotStats.overall.total_annotations} total annotations)</p>`;
            }

            if (routings.length > 0) {
                html += '<table style="margin-top: 10px;"><tr><th>File</th><th>Type</th><th>Routed To</th><th>Reason</th><th>Confidence</th><th>Action</th></tr>';
                for (const r of routings) {
                    const routedTo = JSON.parse(r.routed_to || '[]').join(', ');
                    const confColor = r.confidence >= 0.8 ? '#00ff00' : r.confidence >= 0.5 ? '#ffaa00' : '#ff0000';
                    html += `<tr>`;
                    html += `<td>${r.filename}</td>`;
                    html += `<td>${r.file_type || 'N/A'}</td>`;
                    html += `<td>${routedTo}</td>`;
                    html += `<td style="font-size: 12px;">${(r.reason || '').substring(0, 50)}...</td>`;
                    html += `<td style="color:${confColor}">${(r.confidence || 0).toFixed(2)}</td>`;
                    html += `<td><button onclick="openAnnotationForm(${r.id}, '${r.filename}', '${r.routed_to}')" style="background: #003300; border: 1px solid #00ff00; color: #00ff00; padding: 5px 10px; cursor: pointer;">Annotate</button></td>`;
                    html += `</tr>`;
                }
                html += '</table>';
            } else {
                html += '<p style="color: #00cc00;">No routing decisions pending annotation. Great work!</p>';
            }

            // Add feedback form
            html += '<h3 style="margin: 30px 0 10px;">‚ûï Provide Fleet Feedback</h3>';
            html += '<form id="feedback-form" style="background: #111; padding: 20px; border: 1px solid #00ff00; margin-top: 10px;">';
            html += '<div style="margin-bottom: 10px;"><label>Provider: <input type="text" id="fb-provider" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 200px;" placeholder="e.g. Groq"></label></div>';
            html += '<div style="margin-bottom: 10px;"><label>Task Type: <input type="text" id="fb-task" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 200px;" placeholder="e.g. html_generation"></label></div>';
            html += '<div style="margin-bottom: 10px;"><label>Quality (1-5): <input type="number" id="fb-quality" min="1" max="5" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 80px;" value="3"></label></div>';
            html += '<div style="margin-bottom: 10px;"><label>Issues: <input type="text" id="fb-issues" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 400px;" placeholder="comma-separated: wrong_tech_stack, syntax_errors"></label></div>';
            html += '<div style="margin-bottom: 10px;"><label>Notes: <textarea id="fb-notes" rows="3" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 100%;" placeholder="Explain what was wrong and why..."></textarea></label></div>';
            html += '<div style="margin-bottom: 10px;"><label>Prompt: <textarea id="fb-prompt" rows="2" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 100%;" placeholder="Original prompt sent to fleet"></textarea></label></div>';
            html += '<div style="margin-bottom: 10px;"><label>Output: <textarea id="fb-output" rows="3" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 100%;" placeholder="What the fleet generated"></textarea></label></div>';
            html += '<button type="button" onclick="submitFeedback()" style="background: #003300; border: 1px solid #00ff00; color: #00ff00; padding: 10px 20px; cursor: pointer;">Submit Feedback</button>';
            html += '</form>';

            // Annotation Form (hidden by default)
            html += '<div id="annotation-form-container" style="display: none; background: #111; padding: 20px; border: 2px solid #00ff00; margin-top: 20px;">';
            html += '<h3>‚úçÔ∏è Annotate Routing Decision</h3>';
            html += '<p id="annotation-file-info" style="color: #00cc00; margin-bottom: 15px;"></p>';
            html += '<input type="hidden" id="annotation-routing-id">';
            html += '<input type="hidden" id="annotation-filename">';
            html += '<input type="hidden" id="annotation-routed-to">';
            html += '<div style="margin-bottom: 15px;">';
            html += '<label style="margin-right: 20px;"><input type="radio" name="is-correct" value="true"> ‚úì Correct</label>';
            html += '<label><input type="radio" name="is-correct" value="false"> ‚úó Wrong</label>';
            html += '</div>';
            html += '<div style="margin-bottom: 15px;"><label>Notes (explain WHY):<br><textarea id="annotation-notes" rows="4" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 100%;" placeholder="Explain why this routing is correct or wrong..."></textarea></label></div>';
            html += '<div id="corrected-dest-container" style="margin-bottom: 15px; display: none;"><label>Corrected Destination (comma-separated):<br><input type="text" id="corrected-destination" style="background: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px; width: 100%;" placeholder="e.g. code_review, documents"></label></div>';
            html += '<button onclick="submitAnnotation()" style="background: #003300; border: 1px solid #00ff00; color: #00ff00; padding: 10px 20px; cursor: pointer; margin-right: 10px;">Submit Annotation</button>';
            html += '<button onclick="closeAnnotationForm()" style="background: #330000; border: 1px solid #ff0000; color: #ff0000; padding: 10px 20px; cursor: pointer;">Cancel</button>';
            html += '</div>';

            html += '</div>';
            document.getElementById('modal-body').innerHTML = html;

            // Add event listener for correct/wrong radio buttons
            const radios = document.getElementsByName('is-correct');
            for (const radio of radios) {
                radio.addEventListener('change', () => {
                    const correctedContainer = document.getElementById('corrected-dest-container');
                    if (radio.value === 'false' && radio.checked) {
                        correctedContainer.style.display = 'block';
                    } else {
                        correctedContainer.style.display = 'none';
                    }
                });
            }
        }

        function openAnnotationForm(routingId, filename, routedToJson) {
            const routedTo = JSON.parse(routedToJson || '[]');
            document.getElementById('annotation-routing-id').value = routingId;
            document.getElementById('annotation-filename').value = filename;
            document.getElementById('annotation-routed-to').value = routedToJson;
            document.getElementById('annotation-file-info').textContent = `File: ${filename} ‚Üí Routed to: ${routedTo.join(', ')}`;
            document.getElementById('annotation-form-container').style.display = 'block';
            // Clear previous values
            document.getElementById('annotation-notes').value = '';
            document.getElementById('corrected-destination').value = '';
            const radios = document.getElementsByName('is-correct');
            for (const r of radios) r.checked = false;
            document.getElementById('corrected-dest-container').style.display = 'none';
        }

        function closeAnnotationForm() {
            document.getElementById('annotation-form-container').style.display = 'none';
        }

        async function submitAnnotation() {
            const routingId = parseInt(document.getElementById('annotation-routing-id').value);
            const filename = document.getElementById('annotation-filename').value;
            const routedToJson = document.getElementById('annotation-routed-to').value;
            const routedTo = JSON.parse(routedToJson || '[]');
            const notes = document.getElementById('annotation-notes').value;
            const isCorrectRadio = document.querySelector('input[name="is-correct"]:checked');
            const correctedDestStr = document.getElementById('corrected-destination').value;

            // Validate
            if (!isCorrectRadio) {
                alert('Please select whether the routing was correct or wrong');
                return;
            }
            if (!notes.trim()) {
                alert('Please provide notes explaining why');
                return;
            }

            const isCorrect = isCorrectRadio.value === 'true';
            let correctedDestination = null;

            if (!isCorrect && correctedDestStr.trim()) {
                correctedDestination = correctedDestStr.split(',').map(s => s.trim()).filter(s => s);
            }

            // Submit
            try {
                const r = await fetch('/api/annotations/provide', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        routing_id: routingId,
                        filename: filename,
                        routed_to: routedTo,
                        is_correct: isCorrect,
                        notes: notes,
                        corrected_destination: correctedDestination
                    })
                });
                const data = await r.json();
                if (data.success) {
                    alert('Annotation submitted successfully!');
                    closeAnnotationForm();
                    // Reload modal to show updated stats and remove annotated item
                    loadLearningModal();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch(e) {
                alert('Failed to submit annotation: ' + e.message);
            }
        }

        async function submitFeedback() {
            const provider = document.getElementById('fb-provider').value;
            const task = document.getElementById('fb-task').value;
            const quality = parseInt(document.getElementById('fb-quality').value);
            const issuesStr = document.getElementById('fb-issues').value;
            const notes = document.getElementById('fb-notes').value;
            const prompt = document.getElementById('fb-prompt').value;
            const output = document.getElementById('fb-output').value;

            // Validate
            if (!provider || !task || !notes || !prompt || !output) {
                alert('Please fill in all required fields: provider, task, notes, prompt, output');
                return;
            }

            // Parse issues
            const issues = issuesStr ? issuesStr.split(',').map(s => s.trim()) : [];

            // Submit
            try {
                const r = await fetch('/api/feedback/provide', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        provider, task_type: task, quality, issues, notes, prompt, output
                    })
                });
                const data = await r.json();
                if (data.success) {
                    alert('Feedback submitted successfully!');
                    // Clear form
                    document.getElementById('fb-provider').value = '';
                    document.getElementById('fb-task').value = '';
                    document.getElementById('fb-quality').value = '3';
                    document.getElementById('fb-issues').value = '';
                    document.getElementById('fb-notes').value = '';
                    document.getElementById('fb-prompt').value = '';
                    document.getElementById('fb-output').value = '';
                    // Reload modal to show updated stats
                    loadLearningModal();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch(e) {
                alert('Failed to submit feedback: ' + e.message);
            }
        }

        // ‚îÄ‚îÄ FILES MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _currentFolder = 'pending';
        let _currentPage = 1;

// Routing Approval Modal (Generated using free fleet pattern)

async function loadRoutingApprovalModal() {
    const r = await fetch('/api/routing/proposed');
    const d = await r.json();
    const proposed = d.proposed || [];
    
    let html = '<div style="margin-bottom: 15px;">';
    html += '<strong>' + d.total + ' Proposed Folders</strong> - ';
    html += '<button onclick="selectAllProposed()" style="background:#003300;border:1px solid #00ff00;color:#00ff00;padding:5px 10px;cursor:pointer;margin-right:5px;">Select All</button>';
    html += '<button onclick="promoteSelected()" style="background:#003300;border:1px solid #00ff00;color:#00ff00;padding:8px 16px;cursor:pointer;margin-right:5px;">Promote Selected</button>';
    html += '</div>';
    
    html += '<table><tr><th><input type="checkbox" id="select-all-proposed" onchange="toggleAllProposed(this)"></th><th>Folder</th><th>Files</th><th>First Seen</th><th>Suggestion</th><th>Actions</th></tr>';
    
    for (const p of proposed) {
        const suggestionColor = p.suggestion.startsWith('merge') ? '#ffaa00' : '#00ff00';
        const suggestionText = p.suggestion.replace('merge_into_', 'Merge -> ').replace('promote', 'Promote');
        
        html += '<tr>';
        html += '<td><input type="checkbox" class="proposed-checkbox" value="' + p.name + '"></td>';
        html += '<td><strong>' + p.name + '</strong></td>';
        html += '<td>' + p.count + '</td>';
        html += '<td style="font-size:11px;">' + p.first_seen + '</td>';
        html += '<td style="color:' + suggestionColor + ';font-size:11px;">' + suggestionText + '</td>';
        html += '<td>';
        html += '<button onclick="promoteSingle(\'' + p.name + '\')" style="background:#003300;border:1px solid #00ff00;color:#00ff00;padding:3px 8px;cursor:pointer;margin-right:3px;">Promote</button>';
        if (p.similar_canonical.length > 0) {
            html += '<button onclick="mergeFolder(\'' + p.name + '\', \'' + p.similar_canonical[0] + '\')" style="background:#110011;border:1px solid #aa00ff;color:#aa00ff;padding:3px 8px;cursor:pointer;">Merge->' + p.similar_canonical[0] + '</button>';
        }
        html += '</td>';
        html += '</tr>';
    }
    html += '</table>';
    
    document.getElementById('modal-body').innerHTML = html;
}

function toggleAllProposed(checkbox) {
    document.querySelectorAll('.proposed-checkbox').forEach(cb => cb.checked = checkbox.checked);
}

function selectAllProposed() {
    document.querySelectorAll('.proposed-checkbox').forEach(cb => cb.checked = true);
}

async function promoteSelected() {
    const checked = [...document.querySelectorAll('.proposed-checkbox:checked')].map(c => c.value);
    if (checked.length === 0) { alert('No folders selected'); return; }
    
    if (!confirm('Promote ' + checked.length + ' folders to canonical?\n\n' + checked.join(', '))) return;
    
    const r = await fetch('/api/routing/batch_promote', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({folders: checked})
    });
    const d = await r.json();
    
    if (d.success) {
        alert('Success! Promoted ' + d.promoted.length + ' folders');
        loadRoutingApprovalModal();
    } else {
        alert('Error: ' + (d.error || 'Unknown error'));
    }
}

async function promoteSingle(folderName) {
    if (!confirm('Promote "' + folderName + '" to canonical folder?')) return;
    
    const r = await fetch('/api/routing/batch_promote', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({folders: [folderName]})
    });
    const d = await r.json();
    
    if (d.success && d.promoted.length > 0) {
        alert('Success! Promoted "' + folderName + '"');
        loadRoutingApprovalModal();
    } else {
        alert('Error promoting folder');
    }
}

async function mergeFolder(proposed, into) {
    if (!confirm('Merge "' + proposed + '" into "' + into + '"?\n\nAll files will move.')) return;
    
    const r = await fetch('/api/routing/merge', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({proposed, into})
    });
    const d = await r.json();
    
    if (d.success) {
        alert('Success! Merged ' + d.moved_files + ' files from ' + d.from + ' to ' + d.to);
        loadRoutingApprovalModal();
    } else {
        alert('Error: ' + (d.error || 'Unknown error'));
    }
}
        async function loadFilesModal() {
            const r = await fetch('/api/files/folders');
            const d = await r.json();
            const folders = d.folders || [];
            const proposed = d.proposed || {};

            let sidebar = '<div style="width:200px;flex-shrink:0;border-right:1px solid #00ff00;padding-right:15px;margin-right:15px;">';
            sidebar += '<h3 style="margin-bottom:10px;">Folders</h3>';
            for (const f of folders) {
                const active = f.name === _currentFolder ? 'color:#000;background:#00ff00;' : '';
                sidebar += `<div onclick="loadFileList('${f.name}')" style="cursor:pointer;padding:4px 8px;margin:2px 0;${active}">${f.name} <span style="color:#666;font-size:11px;">(${f.count})</span></div>`;
            }
            if (Object.keys(proposed).length > 0) {
                sidebar += '<h3 style="margin:15px 0 10px;">Proposed</h3>';
                for (const [name, info] of Object.entries(proposed)) {
                    sidebar += `<div style="padding:4px 8px;margin:2px 0;color:#ffaa00;">${name} <span style="font-size:11px;">(${info.count}x)</span>`;
                    sidebar += `<button onclick="promoteFolder('${name}')" style="margin-left:5px;background:#003300;border:1px solid #00ff00;color:#00ff00;font-size:10px;cursor:pointer;padding:1px 4px;">+</button>`;
                    sidebar += `<button onclick="rejectFolder('${name}')" style="margin-left:2px;background:#330000;border:1px solid #ff0000;color:#ff0000;font-size:10px;cursor:pointer;padding:1px 4px;">x</button>`;
                    sidebar += `</div>`;
                }
            }
            sidebar += '</div>';

            let html = `<div style="display:flex;min-height:400px;">${sidebar}<div id="file-list-pane" style="flex:1;">Loading...</div></div>`;
            document.getElementById('modal-body').innerHTML = html;
            await loadFileList(_currentFolder);
        }

        async function loadFileList(folder, page) {
            _currentFolder = folder;
            _currentPage = page || 1;
            const r = await fetch(`/api/files/list?folder=${encodeURIComponent(folder)}&page=${_currentPage}&per_page=30`);
            const d = await r.json();
            const files = d.files || [];
            const total = d.total || 0;
            const pages = Math.ceil(total / 30);

            let html = `<div style="margin-bottom:10px;"><strong>${folder}/</strong> ‚Äî ${total} files</div>`;

            if (files.length === 0) {
                html += '<p style="color:#666;">Empty folder.</p>';
            } else {
                html += '<table style="width:100%;font-size:12px;"><tr><th style="text-align:left;">Name</th><th>Size</th><th>Modified</th></tr>';
                for (const f of files) {
                    html += `<tr>
                        <td style="max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                            <span onclick="openFileDetail('${escapeQ(f.name)}','${escapeQ(folder)}')" style="cursor:pointer;color:#00ff00;text-decoration:underline;" title="Click to view, tag, chat">${f.name}</span>
                        </td>
                        <td style="color:#888;">${f.size_human}</td>
                        <td style="color:#888;">${f.modified}</td>
                    </tr>`;
                }
                html += '</table>';
            }

            if (pages > 1) {
                html += '<div style="margin-top:10px;">';
                for (let i = 1; i <= pages; i++) {
                    const active = i === _currentPage ? 'background:#00ff00;color:#000;' : '';
                    html += `<button onclick="loadFileList('${folder}',${i})" style="${active}border:1px solid #00ff00;color:#00ff00;background:#001100;cursor:pointer;padding:3px 8px;margin:2px;">${i}</button>`;
                }
                html += '</div>';
            }

            document.getElementById('file-list-pane').innerHTML = html;
        }

        function escapeQ(s) { return s.replace(/'/g, "\\'"); }

        async function openFileDetail(filename, folder) {
            // Fetch preview and schema in parallel
            const [prevR, schemaR] = await Promise.all([
                fetch(`/api/files/preview?file=${encodeURIComponent(filename)}&folder=${encodeURIComponent(folder)}`),
                fetch('/api/routing/schema')
            ]);
            const prev = await prevR.json();
            const schema = await schemaR.json();

            let previewHtml = '';
            if (prev.type === 'image') {
                previewHtml = `<img src="data:${prev.mime};base64,${prev.data}" style="max-width:100%;max-height:300px;border:1px solid #333;">`;
            } else if (prev.type === 'text') {
                previewHtml = `<pre style="background:#111;padding:10px;font-size:11px;max-height:300px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;">${prev.content.replace(/</g,'&lt;')}${prev.truncated ? '\n\n[truncated...]' : ''}</pre>`;
            } else {
                previewHtml = `<div style="padding:20px;text-align:center;color:#666;">Binary file (${prev.ext || 'unknown'})<br>${_fmtSize(prev.size)}</div>`;
            }

            const folderOpts = (schema.canonical || []).map(f =>
                `<option value="${f}"${f===folder?' selected':''}>${f}</option>`).join('');

            const overlay = document.createElement('div');
            overlay.id = 'file-detail-overlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);z-index:3000;display:flex;flex-direction:column;';
            overlay.innerHTML = `
                <div style="display:flex;align-items:center;padding:10px 20px;border-bottom:1px solid #00ff00;">
                    <span style="flex:1;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${filename}"><strong>${filename}</strong> &mdash; ${folder}/</span>
                    <button onclick="document.getElementById('file-detail-overlay').remove()" style="background:#330000;border:1px solid #ff0000;color:#ff0000;padding:5px 15px;cursor:pointer;">Close</button>
                </div>
                <div style="display:flex;flex:1;overflow:hidden;">
                    <!-- LEFT: preview + tag -->
                    <div style="width:420px;flex-shrink:0;border-right:1px solid #333;padding:15px;overflow-y:auto;">
                        <div style="margin-bottom:15px;">${previewHtml}</div>
                        <div style="font-size:11px;color:#666;margin-bottom:15px;">
                            ${_fmtSize(prev.size)} &bull; ${prev.ext || '?'} &bull; ${folder}/
                        </div>

                        <h4 style="margin-bottom:8px;">Tag this file</h4>
                        <label style="font-size:11px;">Ring</label>
                        <select id="fd-ring" style="width:100%;background:#111;border:1px solid #333;color:#aaa;padding:4px;margin:2px 0 8px;font-size:11px;">
                            <option value="">-- no change --</option>
                            <option value="source">source</option>
                            <option value="bridge">bridge</option>
                            <option value="continuity">continuity</option>
                        </select>
                        <label style="font-size:11px;">Category</label>
                        <input id="fd-category" type="text" placeholder="e.g. governance, personal" style="width:100%;background:#111;border:1px solid #333;color:#aaa;padding:4px;margin:2px 0 8px;font-size:11px;">
                        <label style="font-size:11px;">Move to folder</label>
                        <select id="fd-move" style="width:100%;background:#111;border:1px solid #333;color:#aaa;padding:4px;margin:2px 0 8px;font-size:11px;">
                            ${folderOpts}
                        </select>
                        <label style="font-size:11px;">Was routing correct?</label>
                        <div style="margin:4px 0 8px;">
                            <label style="font-size:11px;"><input type="radio" name="fd-correct" value="true"> Yes</label>
                            <label style="font-size:11px;margin-left:10px;"><input type="radio" name="fd-correct" value="false"> No, should be:
                                <select id="fd-corrected" style="background:#111;border:1px solid #333;color:#ff6666;padding:2px;font-size:11px;">
                                    <option value="">--</option>${folderOpts}
                                </select>
                            </label>
                        </div>
                        <button onclick="submitFileDetail('${escapeQ(filename)}','${escapeQ(folder)}')" style="width:100%;background:#003300;border:1px solid #00ff00;color:#00ff00;padding:8px;cursor:pointer;margin-top:5px;">Save</button>
                    </div>

                    <!-- RIGHT: contextual chat -->
                    <div style="flex:1;display:flex;flex-direction:column;padding:15px;">
                        <h4 style="margin-bottom:8px;">Chat about this file</h4>
                        <div id="fd-chat-log" style="flex:1;overflow-y:auto;background:#0a0a0a;border:1px solid #222;padding:10px;font-size:12px;margin-bottom:10px;min-height:200px;">
                            <div style="color:#666;font-style:italic;">Ask Willow about this file, its content, where it belongs, or anything about the system...</div>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <input id="fd-chat-input" type="text" placeholder="Ask about this file or folder..." onkeydown="if(event.key==='Enter')sendFileChat('${escapeQ(filename)}','${escapeQ(folder)}')"
                                style="flex:1;background:#111;border:1px solid #00ff00;color:#00ff00;padding:8px;font-family:monospace;font-size:12px;">
                            <button onclick="sendFileChat('${escapeQ(filename)}','${escapeQ(folder)}')" style="background:#003300;border:1px solid #00ff00;color:#00ff00;padding:8px 15px;cursor:pointer;">Send</button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(overlay);

            // Seed chat with file context (silent ‚Äî not shown to user, just context)
            window._fdChatContext = `[File context: "${filename}" in folder "${folder}". Size: ${_fmtSize(prev.size)}. Type: ${prev.type}.${prev.type==='text'?' Content preview: '+prev.content?.slice(0,300):''}]`;
        }

        function _fmtSize(n) {
            if (!n) return '?';
            if (n < 1024) return n + 'B';
            if (n < 1048576) return (n/1024).toFixed(0) + 'KB';
            return (n/1048576).toFixed(1) + 'MB';
        }

        async function sendFileChat(filename, folder) {
            const input = document.getElementById('fd-chat-input');
            const log = document.getElementById('fd-chat-log');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';

            // Append user message
            log.innerHTML += `<div style="margin:8px 0;"><span style="color:#888;">You:</span> ${msg.replace(/</g,'&lt;')}</div>`;
            log.innerHTML += `<div id="fd-chat-response" style="margin:8px 0;"><span style="color:#00ff00;">Willow:</span> <span id="fd-chat-text" style="color:#ccc;"></span></div>`;
            log.scrollTop = log.scrollHeight;

            // Inject file context into prompt
            const contextPrompt = window._fdChatContext + '\n\nUser: ' + msg;

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({prompt: contextPrompt, persona: 'Willow'})
                });
                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let text = '';
                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    for (const line of chunk.split('\n')) {
                        if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                            text += line.slice(6);
                            document.getElementById('fd-chat-text').textContent = text;
                            log.scrollTop = log.scrollHeight;
                        }
                    }
                }
                // Build up context for follow-ups
                window._fdChatContext += `\nUser: ${msg}\nWillow: ${text}`;
            } catch(e) {
                document.getElementById('fd-chat-text').textContent = `Error: ${e.message}`;
            }
        }

        async function submitFileDetail(filename, fromFolder) {
            const ring = document.getElementById('fd-ring').value;
            const category = document.getElementById('fd-category').value;
            const toFolder = document.getElementById('fd-move').value;
            const correctRadio = document.querySelector('input[name="fd-correct"]:checked');
            const correct = correctRadio?.value;
            const corrected = document.getElementById('fd-corrected').value;

            // Move if folder changed
            if (toFolder && toFolder !== fromFolder) {
                await fetch(`/api/files/move?filename=${encodeURIComponent(filename)}&from_folder=${encodeURIComponent(fromFolder)}&to_folder=${encodeURIComponent(toFolder)}`, {method: 'POST'});
            }

            // Tag
            let url = `/api/files/tag?filename=${encodeURIComponent(filename)}&folder=${encodeURIComponent(toFolder||fromFolder)}`;
            if (ring) url += `&ring=${ring}`;
            if (category) url += `&category=${encodeURIComponent(category)}`;
            if (correct) url += `&feedback_correct=${correct}`;
            if (correct === 'false' && corrected) url += `&corrected_folder=${encodeURIComponent(corrected)}`;
            await fetch(url, {method: 'POST'});

            document.getElementById('file-detail-overlay').remove();
            await loadFileList(toFolder || fromFolder, _currentPage);
        }

        async function openFileTag(filename, folder) {
            const r = await fetch('/api/routing/schema');
            const schema = await r.json();
            const canonical = (schema.canonical || []).join('", "');

            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;display:flex;align-items:center;justify-content:center;';
            overlay.innerHTML = `
                <div style="background:#0a0a0a;border:2px solid #00ff00;padding:25px;width:500px;max-height:80vh;overflow-y:auto;">
                    <h3 style="margin-bottom:15px;">Tag: ${filename}</h3>
                    <p style="color:#888;margin-bottom:15px;">Currently in: ${folder}</p>

                    <label>Ring</label>
                    <select id="tag-ring" style="width:100%;background:#111;border:1px solid #00ff00;color:#00ff00;padding:6px;margin:5px 0 15px;">
                        <option value="">-- no change --</option>
                        <option value="source">source (governance)</option>
                        <option value="bridge">bridge (processed file)</option>
                        <option value="continuity">continuity (conversation/journal)</option>
                    </select>

                    <label>Category</label>
                    <input id="tag-category" type="text" placeholder="e.g. governance, personal, work" style="width:100%;background:#111;border:1px solid #00ff00;color:#00ff00;padding:6px;margin:5px 0 15px;">

                    <label>Tags (comma-separated)</label>
                    <input id="tag-tags" type="text" placeholder="e.g. important, review-later" style="width:100%;background:#111;border:1px solid #00ff00;color:#00ff00;padding:6px;margin:5px 0 15px;">

                    <label>Was this routing correct?</label>
                    <div style="margin:5px 0 10px;">
                        <label><input type="radio" name="tag-correct" value="true"> Yes</label>
                        <label style="margin-left:15px;"><input type="radio" name="tag-correct" value="false"> No, should be:</label>
                        <select id="tag-corrected" style="background:#111;border:1px solid #ff0000;color:#ff0000;padding:4px;margin-left:5px;">
                            <option value="">-- select --</option>
                            ${(schema.canonical || []).map(f => `<option value="${f}">${f}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-top:20px;display:flex;gap:10px;">
                        <button onclick="submitTag('${escapeQ(filename)}','${escapeQ(folder)}')" style="background:#003300;border:1px solid #00ff00;color:#00ff00;padding:8px 20px;cursor:pointer;flex:1;">Save Tag</button>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background:#330000;border:1px solid #ff0000;color:#ff0000;padding:8px 20px;cursor:pointer;">Cancel</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
        }

        async function submitTag(filename, folder) {
            const ring = document.getElementById('tag-ring').value;
            const category = document.getElementById('tag-category').value;
            const tags = document.getElementById('tag-tags').value;
            const correctRadio = document.querySelector('input[name="tag-correct"]:checked');
            const correct = correctRadio ? correctRadio.value : null;
            const corrected = document.getElementById('tag-corrected').value;

            let url = `/api/files/tag?filename=${encodeURIComponent(filename)}&folder=${encodeURIComponent(folder)}`;
            if (ring) url += `&ring=${ring}`;
            if (category) url += `&category=${encodeURIComponent(category)}`;
            if (tags) url += `&tags=${encodeURIComponent(tags)}`;
            if (correct !== null) url += `&feedback_correct=${correct}`;
            if (correct === 'false' && corrected) url += `&corrected_folder=${encodeURIComponent(corrected)}`;

            const r = await fetch(url, {method: 'POST'});
            const d = await r.json();
            document.querySelector('div[style*=position\\:fixed]')?.remove();
            if (d.error) alert(`Error: ${d.error}`);
            else { alert(`Tagged: ${filename}`); await loadFileList(folder, _currentPage); }
        }

        async function openFileMove(filename, folder) {
            const r = await fetch('/api/routing/schema');
            const schema = await r.json();

            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;display:flex;align-items:center;justify-content:center;';
            overlay.innerHTML = `
                <div style="background:#0a0a0a;border:2px solid #aa00ff;padding:25px;width:400px;">
                    <h3 style="margin-bottom:15px;">Move: ${filename}</h3>
                    <p style="color:#888;margin-bottom:15px;">From: ${folder}</p>
                    <label>To Folder</label>
                    <select id="move-to" style="width:100%;background:#111;border:1px solid #aa00ff;color:#aa00ff;padding:6px;margin:5px 0 20px;">
                        ${(schema.canonical || []).map(f => `<option value="${f}">${f}</option>`).join('')}
                    </select>
                    <div style="display:flex;gap:10px;">
                        <button onclick="submitMove('${escapeQ(filename)}','${escapeQ(folder)}')" style="background:#110011;border:1px solid #aa00ff;color:#aa00ff;padding:8px 20px;cursor:pointer;flex:1;">Move</button>
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="background:#330000;border:1px solid #ff0000;color:#ff0000;padding:8px 20px;cursor:pointer;">Cancel</button>
                    </div>
                </div>`;
            document.body.appendChild(overlay);
        }

        async function submitMove(filename, fromFolder) {
            const toFolder = document.getElementById('move-to').value;
            const r = await fetch(`/api/files/move?filename=${encodeURIComponent(filename)}&from_folder=${encodeURIComponent(fromFolder)}&to_folder=${encodeURIComponent(toFolder)}`, {method: 'POST'});
            const d = await r.json();
            document.querySelector('div[style*=position\\:fixed]')?.remove();
            if (d.error) alert(`Error: ${d.error}`);
            else { alert(`Moved to ${toFolder}`); await loadFileList(fromFolder, _currentPage); }
        }

        async function promoteFolder(name) {
            if (!confirm(`Promote "${name}" to canonical folder?`)) return;
            const r = await fetch(`/api/routing/promote?folder=${encodeURIComponent(name)}`, {method: 'POST'});
            const d = await r.json();
            if (d.error) alert(`Error: ${d.error}`);
            else { alert(`"${name}" is now canonical`); await loadFilesModal(); }
        }

        async function rejectFolder(name) {
            if (!confirm(`Reject "${name}"? Files will move to archive.`)) return;
            const r = await fetch(`/api/routing/reject?folder=${encodeURIComponent(name)}`, {method: 'POST'});
            const d = await r.json();
            if (d.error) alert(`Error: ${d.error}`);
            else { alert(`"${name}" rejected`); await loadFilesModal(); }
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
        }

        function closeModalIfOverlay(e) {
            if (e.target.id === 'modal-overlay') closeModal();
        }

        function getModalTitle(type) {
            const titles = {
                'providers': 'üåê Provider Mesh Details',
                'queues': 'üì• Queue Management',
                'nodes': 'üå≥ Node Health & Database Management',
                'learning': 'ü§ñ LLM Fleet Feedback',
                'rules': 'üí° Suggested Routing Rules',
                'patterns': 'üìÇ File Routing Patterns',
                'governance': '‚öñÔ∏è Governance & Dual Commit',
                'safe': 'üîí SAFE Sync Status',
                'files': 'üìÅ File Browser & Tagger',
                'routing-approval': 'üìã Routing Approval Dashboard',
            };
            return titles[type] || type;
        }

        loadSummaries();
    </script>
</body>
</html>
